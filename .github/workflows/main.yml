name: Gold & Egg Price Tracker

on:
  push:
    branches: ['**']      # è°ƒè¯•æœŸæ”¾å®½ï¼›ä¸Šçº¿åå¯æ”¶ç´§åˆ° main
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'   # æ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰æ‰§è¡Œä¸€æ¬¡

jobs:
  update-prices:
    # æ¨é€è§¦å‘æ—¶ä»…åœ¨æäº¤æ¶ˆæ¯åŒ…å« run æ—¶æ‰æ‰§è¡Œï¼Œå…¶ä½™è§¦å‘ä¿æŒ
    if: ${{ github.event_name != 'push' || contains(join(github.event.commits.*.message, ' '), 'run') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™ä»¥æäº¤æ•°æ®æ–‡ä»¶
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -V
          pip install requests beautifulsoup4

      - name: Fetch gold and egg prices
        run: |
          python scripts/gold_egg_price.py

      - name: Generate HTML report
        run: |
          python scripts/generate_html.py

      - name: Commit and push data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/price_history.json index.html
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ä»·æ ¼æ•°æ® $(date +'%Y-%m-%d %H:%M')"
          git push

      - name: Send email via Gmail SMTP
        # å®šæ—¶ã€æ‰‹åŠ¨è§¦å‘æˆ–æ¨é€æ—¥å¿—åŒ…å« run æ—¶å‘é€é‚®ä»¶
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && contains(join(github.event.commits.*.message, ' '), 'run'))
        env:
          SMTP_HOST: smtp.gmail.com
          SMTP_PORT: 587
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO != '' && format('your-email@example.com,{0}', secrets.EMAIL_TO) || 'your-email@example.com' }}
        run: |
          python scripts/send_email.py
